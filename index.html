<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Moranguinhos do Amor by Sil - Pedido</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/7.6.1/imask.min.js"></script>
  <style>
    body {
      background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"%3E%3Cpath d="M20 5c-2.5 0-4.5 2-4.5 4.5S17.5 14 20 14s4.5-2 4.5-4.5S22.5 5 20 5zm0 6c-1.4 0-2.5-1.1-2.5-2.5S18.6 6 20 6s2.5 1.1 2.5 2.5S21.4 11 20 11z" fill="%23f9a8d4" fill-opacity="0.2"/%3E%3C/svg%3E');
    }
    .strawberry-icon::before {
      content: "游꼡";
      margin-right: 0.5rem;
    }
    #enderecoContainer {
      position: relative;
    }
    #autocomplete-dropdown {
      position: absolute;
      z-index: 10;
      width: 100%;
      background: white;
      border: 1px solid #f9a8d4;
      border-radius: 0.375rem;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .autocomplete-item {
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    .autocomplete-item:hover {
      background-color: #ffe4e6;
    }
  </style>
</head>
<body class="bg-pink-50 flex items-center justify-center min-h-screen">
  <div class="w-full max-w-md p-6 bg-white rounded-lg shadow-lg border-2 border-pink-300">
    <h1 class="text-2xl font-bold text-center mb-6 text-red-500 strawberry-icon">Moranguinhos do Amor by Sil</h1>
    <p class="text-center text-sm text-red-600 mb-4">Pre칞o por unidade: R$ 10,00</p>
    <p id="taxaEntrega" class="text-center text-sm text-red-600 mb-4 hidden">Taxa de entrega estimada: R$ <span id="taxaValor">5,00</span> (pode variar no momento da entrega)</p>
    <form id="pedidoForm" class="space-y-4">
      <div>
        <label for="nome" class="block text-sm font-medium text-red-600 strawberry-icon">Nome</label>
        <input type="text" id="nome" name="nome" required class="mt-1 block w-full px-3 py-2 border border-pink-300 rounded-md shadow-sm focus:outline-none focus:ring-red-400 focus:border-red-400 bg-pink-50">
      </div>
      <div>
        <label for="celular" class="block text-sm font-medium text-red-600 strawberry-icon">Celular</label>
        <input type="tel" id="celular" name="celular" required class="mt-1 block w-full px-3 py-2 border border-pink-300 rounded-md shadow-sm focus:outline-none focus:ring-red-400 focus:border-red-400 bg-pink-50" placeholder="(99) 99999-9999">
      </div>
      <div>
        <label for="quantidade" class="block text-sm font-medium text-red-600 strawberry-icon">Quantidade</label>
        <input type="number" id="quantidade" name="quantidade" required min="1" class="mt-1 block w-full px-3 py-2 border border-pink-300 rounded-md shadow-sm focus:outline-none focus:ring-red-400 focus:border-red-400 bg-pink-50">
      </div>
      <div>
        <label for="opcao" class="block text-sm font-medium text-red-600 strawberry-icon">Op칞칚o</label>
        <select id="opcao" name="opcao" required class="mt-1 block w-full px-3 py-2 border border-pink-300 rounded-md shadow-sm focus:outline-none focus:ring-red-400 focus:border-red-400 bg-pink-50">
          <option value="retirada">Retirada</option>
          <option value="entrega">Entrega</option>
        </select>
      </div>
      <div id="enderecoContainer" class="hidden space-y-4">
        <div>
          <label for="rua" class="block text-sm font-medium text-red-600 strawberry-icon">Rua</label>
          <input type="text" id="rua" name="rua" class="mt-1 block w-full px-3 py-2 border border-pink-300 rounded-md shadow-sm focus:outline-none focus:ring-red-400 focus:border-red-400 bg-pink-50">
          <div id="autocomplete-dropdown" class="hidden"></div>
        </div>
        <div>
          <label for="numero" class="block text-sm font-medium text-red-600 strawberry-icon">N칰mero</label>
          <input type="text" id="numero" name="numero" class="mt-1 block w-full px-3 py-2 border border-pink-300 rounded-md shadow-sm focus:outline-none focus:ring-red-400 focus:border-red-400 bg-pink-50">
        </div>
        <div>
          <label for="complemento" class="block text-sm font-medium text-red-600 strawberry-icon">Complemento (opcional)</label>
          <input type="text" id="complemento" name="complemento" class="mt-1 block w-full px-3 py-2 border border-pink-300 rounded-md shadow-sm focus:outline-none focus:ring-red-400 focus:border-red-400 bg-pink-50">
        </div>
      </div>
      <p id="valorTotal" class="text-center text-sm font-medium text-red-600"></p>
      <button type="submit" class="w-full bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 strawberry-icon">Confirmar Pedido</button>
    </form>
  </div>

  <script>
    const form = document.getElementById('pedidoForm');
    const opcaoSelect = document.getElementById('opcao');
    const enderecoContainer = document.getElementById('enderecoContainer');
    const quantidadeInput = document.getElementById('quantidade');
    const valorTotalDisplay = document.getElementById('valorTotal');
    const taxaEntregaDisplay = document.getElementById('taxaEntrega');
    const taxaValor = document.getElementById('taxaValor');
    const celularInput = document.getElementById('celular');
    const ruaInput = document.getElementById('rua');
    const numeroInput = document.getElementById('numero');
    const complementoInput = document.getElementById('complemento');
    const autocompleteDropdown = document.getElementById('autocomplete-dropdown');

    const PRECO_UNIDADE = 10;
    const TAXA_BASE_ENTREGA = 5;
    const TAXA_POR_KM = 1;
    let distanciaEstimada = 0; // Armazena a dist칙ncia calculada

    // M치scara para o celular
    const mask = IMask(celularInput, {
      mask: '(00) 00000-0000',
      lazy: false,
      placeholderChar: '_'
    });

    // Configura칞칚o do Photon Autocomplete
    async function initAutocomplete() {
      ruaInput.addEventListener('input', async () => {
        const query = ruaInput.value;
        if (query.length < 3) {
          autocompleteDropdown.classList.add('hidden');
          return;
        }

        // Coordenadas aproximadas de Joinville, SC para priorizar resultados locais
        const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&lat=-26.3044&lon=-48.8464&limit=5`;
        
        try {
          const response = await fetch(url);
          const data = await response.json();
          autocompleteDropdown.innerHTML = '';

          if (data.features && data.features.length > 0) {
            data.features.forEach(feature => {
              const address = feature.properties.street || feature.properties.name || '';
              const neighbourhood = feature.properties.district || '';
              const city = feature.properties.city || '';
              const state = feature.properties.state || '';
              const coordinates = feature.geometry.coordinates; // [lon, lat]
              if (city.toLowerCase() === 'joinville' && state.toLowerCase() === 'santa catarina') {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = neighbourhood ? `${address}, ${neighbourhood}, ${city}, ${state}` : `${address}, ${city}, ${state}`;
                item.dataset.coordinates = JSON.stringify(coordinates);
                item.addEventListener('click', async () => {
                  ruaInput.value = neighbourhood ? `${address}, ${neighbourhood}` : address;
                  autocompleteDropdown.classList.add('hidden');
                  await calcularDistancia(coordinates);
                  calcularValorTotal();
                });
                autocompleteDropdown.appendChild(item);
              }
            });
            autocompleteDropdown.classList.toggle('hidden', autocompleteDropdown.childElementCount === 0);
          } else {
            autocompleteDropdown.classList.add('hidden');
          }
        } catch (error) {
          console.error('Erro ao buscar endere칞os:', error);
          autocompleteDropdown.classList.add('hidden');
        }
      });

      // Fechar dropdown ao clicar fora
      document.addEventListener('click', (e) => {
        if (!enderecoContainer.contains(e.target)) {
          autocompleteDropdown.classList.add('hidden');
        }
      });
    }

    // Fun칞칚o para calcular dist칙ncia usando OpenRouteService
    async function calcularDistancia(destinoCoords) {
      const origemCoords = [-48.8464, -26.3044]; // Aproximado para Rua dos Serventu치rios, 88, Joinville, SC
      const orsApiKey = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImNjNmRkMTdkOWI0NzQzMGE5N2Y5MjEyNWVmZDYwM2QyIiwiaCI6Im11cm11cjY0In0=';
      const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${orsApiKey}&start=${origemCoords[0]},${origemCoords[1]}&end=${destinoCoords[0]},${destinoCoords[1]}`;
      
      try {
        const response = await fetch(url);
        const data = await response.json();
        if (data.features && data.features.length > 0) {
          distanciaEstimada = data.features[0].properties.segments[0].distance / 1000; // Dist칙ncia em km
          const taxaEntrega = TAXA_BASE_ENTREGA + Math.ceil(distanciaEstimada) * TAXA_POR_KM;
          taxaValor.textContent = taxaEntrega.toFixed(2).replace('.', ',');
        } else {
          distanciaEstimada = 0;
          taxaValor.textContent = TAXA_BASE_ENTREGA.toFixed(2).replace('.', ',');
        }
      } catch (error) {
        console.error('Erro ao calcular dist칙ncia:', error);
        distanciaEstimada = 0;
        taxaValor.textContent = TAXA_BASE_ENTREGA.toFixed(2).replace('.', ',');
      }
    }

    function calcularValorTotal() {
      const quantidade = parseInt(quantidadeInput.value) || 0;
      const opcao = opcaoSelect.value;
      let total = quantidade * PRECO_UNIDADE;
      if (opcao === 'entrega') {
        const taxaEntrega = TAXA_BASE_ENTREGA + Math.ceil(distanciaEstimada) * TAXA_POR_KM;
        total += taxaEntrega;
      }
      valorTotalDisplay.textContent = `Valor Total: R$ ${total.toFixed(2).replace('.', ',')}`;
    }

    opcaoSelect.addEventListener('change', () => {
      enderecoContainer.classList.toggle('hidden', opcaoSelect.value !== 'entrega');
      taxaEntregaDisplay.classList.toggle('hidden', opcaoSelect.value !== 'entrega');
      if (opcaoSelect.value === 'entrega') {
        ruaInput.required = true;
        numeroInput.required = true;
        complementoInput.required = false;
        initAutocomplete();
      } else {
        ruaInput.required = false;
        numeroInput.required = false;
        complementoInput.required = false;
        autocompleteDropdown.classList.add('hidden');
        distanciaEstimada = 0;
        taxaValor.textContent = TAXA_BASE_ENTREGA.toFixed(2).replace('.', ',');
      }
      calcularValorTotal();
    });

    quantidadeInput.addEventListener('input', calcularValorTotal);
    ruaInput.addEventListener('input', calcularValorTotal);
    numeroInput.addEventListener('input', calcularValorTotal);
    complementoInput.addEventListener('input', calcularValorTotal);

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const nome = document.getElementById('nome').value;
      const celular = document.getElementById('celular').value;
      const quantidade = document.getElementById('quantidade').value;
      const opcao = document.getElementById('opcao').value;
      const rua = opcao === 'entrega' ? document.getElementById('rua').value : 'N칚o aplic치vel';
      const numero = opcao === 'entrega' ? document.getElementById('numero').value : 'N칚o aplic치vel';
      const complemento = opcao === 'entrega' && document.getElementById('complemento').value ? document.getElementById('complemento').value : 'N칚o informado';
      const endereco = opcao === 'entrega' ? `${rua}, ${numero}${complemento !== 'N칚o informado' ? ', ' + complemento : ''}, Joinville, SC` : 'N칚o aplic치vel';
      const taxaEntrega = opcao === 'entrega' ? TAXA_BASE_ENTREGA + Math.ceil(distanciaEstimada) * TAXA_POR_KM : 0;
      const valorTotal = (quantidade * PRECO_UNIDADE + taxaEntrega).toFixed(2).replace('.', ',');

      const mensagem = `游꼡 Moranguinhos do Amor by Sil 游꼡\nNome: ${nome}\nCelular: ${celular}\nQuantidade: ${quantidade}\nOp칞칚o: ${opcao}\nEndere칞o: ${endereco}\nValor Total: R$ ${valorTotal}${opcao === 'entrega' ? `\nTaxa de Entrega Estimada: R$ ${taxaEntrega.toFixed(2).replace('.', ',')}` : ''}`;
      const numeroWhatsApp = '5547984490544'; // Substitua pelo n칰mero desejado com c칩digo do pa칤s
      const url = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensagem)}`;
      
      window.open(url, '_blank');
    });

    // Inicializar c치lculo do valor total
    calcularValorTotal();
  </script>
</body>
</html>